name: Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  php:
    name: PHP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: dom, json, libxml, mbstring
          coverage: none

      - name: Get composer cache dir
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist

      - name: PHPUnit
        run: php vendor/bin/phpunit

      - name: PHPStan
        run: php vendor/bin/phpstan analyse -c phpstan.neon

      - name: PHPCS
        run: php vendor/bin/phpcs --standard=phpcs.xml

  e2e:
    name: E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start WordPress
        run: docker compose up -d

      - name: Wait for HTTP
        run: |
          for i in $(seq 1 60); do
            if curl -sf -o /dev/null --connect-timeout 2 http://127.0.0.1:8071/; then
              echo "HTTP responding"
              break
            fi

            if [ $i -eq 60 ]; then
              echo "HTTP timeout"
              docker compose logs --no-color
              exit 1
            fi

            sleep 2
          done

          - name: Bootstrap WordPress (install + plugin)
          run: |
            docker compose exec -T wordpress bash -lc '
              set -e
              cd /var/www/html
        
              # Install WP-CLI if missing
              if ! command -v wp >/dev/null 2>&1; then
                curl -sSLo /usr/local/bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
                chmod +x /usr/local/bin/wp
              fi
        
              # Install WordPress only if not installed
              if ! wp core is-installed --allow-root --url="http://127.0.0.1:8071" >/dev/null 2>&1; then
                wp core install \
                  --url="http://127.0.0.1:8071" \
                  --title="Test" \
                  --admin_user="test" \
                  --admin_password="asdf123jkl" \
                  --admin_email="test@test.test" \
                  --skip-email \
                  --allow-root
              else
                echo "WordPress already installed"
              fi
        
              # Activate plugin
              wp plugin activate fapi-signals --allow-root --url="http://127.0.0.1:8071" || true
        
              echo "WordPress + plugin ready"
            '

      - name: Wait for wp-login.php
        run: |
          for i in $(seq 1 36); do
            code=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 5 --max-time 10 \
              http://127.0.0.1:8071/wp-login.php || echo "000")

            if [ "$code" = "200" ]; then
              echo "wp-login.php ready"
              break
            fi

            if [ $i -eq 36 ]; then
              echo "wp-login.php timeout (last code: $code)"
              docker compose logs --no-color
              exit 1
            fi

            sleep 2
          done

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright E2E
        env:
          CI: true
          WP_BASE_URL: http://127.0.0.1:8071
          WP_ADMIN_USER: test
          WP_ADMIN_PASS: asdf123jkl
        run: npm run test:e2e

      - name: Debug logs (only on failure)
        if: failure()
        run: docker compose logs --no-color

      - name: Stop WordPress
        if: always()
        run: docker compose down